<html>
  <head>
    <title>spatiasql.js</title>
    <meta content="">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script>
      $(function () {

        // modified example from sql.js
        var id = 1;
        var worker = new Worker("spatiasql.worker.js");
        var textarea = $('textarea');
        var pre = $('pre');
        var button = $('button');
        button.prop('disabled', true);

        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'test-2.3.sqlite', true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function(e) {
          var uInt8Array = new Uint8Array(this.response);
          worker.postMessage({
              id: id,
              action: 'open',
              buffer: uInt8Array
          });
        };
        xhr.send();

        $('button').on('click', function () {
          var sql = textarea.val().trim();
          if (sql.length > 0) {
            button.prop('disabled', true);
            button.html('...running...');
            id++;
            worker.postMessage({
              id: id,
              action: 'exec',
              sql: sql
            });
          }
        });

        worker.onmessage = function (event) {
          pre.html((typeof event.data === 'string' ? event.data : (
              event.data.results ? JSON.stringify(event.data.results, null, 2) : JSON.stringify(event.data, null, 2)
            )
          ));
          button.prop('disabled', false);
          button.html('run');              
        };

        worker.onerror = function (event) {
          pre.html('Error: ' + event.message);
          button.prop('disabled', false);
          button.html('run');              
        };

      });
    </script>

    <style>
      * {
        box-sizing: border-box;
      }
      .absolute-center {
        margin-left: auto;
        margin-right: auto;
        position: absolute;
        top: 20; left: 0; bottom: 0; right: 0;
      }
      body {
        background-color: #eee;
      }
      body > div {
        width: 800px;
        height: 800px;
      }
      pre {
        width: 800px;
        height: 300px;
        margin: 0px;
        padding: 2px;
        background-color: white;
        border: 2px solid;
        border-color: grey;
        border-radius: 4px;
        overflow-x: hidden;
        overflow-y: scroll;
      }
      textarea {
        border: 2px solid;
        border-color: steelblue;
        border-radius: 4px;
        max-width: 800px;     
        min-width: 800px;     
      }
      button {
        width: 80px;
        height: 30px;
        margin-top: 10px;
        margin-bottom: 10px;
        display: block;
        border: 1px solid;
        border-color: grey;
        border-radius: 4px;
        float: right;
      }
      span {
        width: 100%;
        text-align: center;
        display: block;
        line-height: 200%;
        font-size: 180%;
        font-family: Georgia, serif;
      }
      a {
        text-decoration: none;
        color: steelblue;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class='absolute-center'>
      <span><a href="https://github.com/jvail/spatiasql.js">spatiasql.js</a> - Run SQL queries on <a href='https://www.gaia-gis.it/spatialite-2.3.1/resources.html'>spatialite example db</a></span>
      <textarea rows="20" cols="90">
SELECT sqlite_version(), spatialite_version(), proj4_version(), geos_version();

-- a few example queries from https://www.gaia-gis.it/spatialite-2.3.1/resources.html

SELECT name, peoples FROM towns WHERE peoples > 350000 ORDER BY peoples DESC;
--expect:
--Name|Peoples
--Roma|2546804
--Milano|1256211
--Napoli|1004500
--Torino|865263
--Palermo|686722
--Genova|610307
--Bologna|371217
--Firenze|356118

SELECT HEX(AsBinary(GeomFromText('POINT(10 20)')));
--expect: 
--010100000000000000000024400000000000003440


SELECT AsText(InteriorRingN(Geometry, 1)),
  AsText(PointN(InteriorRingN(Geometry, 1), 4)),
  X(PointN(InteriorRingN(Geometry, 1), 5)),
  Y(PointN(InteriorRingN(Geometry, 1), 5))
  FROM Regions WHERE PK_UID = 55;

--expect:
--LINESTRING(756881.706704 4850692.62625, 760361.595005 4852743.267975, 759582.880944 4855493.610807, 757549.382306 4855414.551183, 755734.189332 4856112.118807, 755020.910885 4855996.887913, 754824.031873 4854723.577451, 756021.000385 4850937.420842, 756881.706704 4850692.62625)|POINT(757549.382306 4855414.551183)|755734.189332257|4856112.11880693
      </textarea>
      <div><button>...loading...</button></div>
      <pre></pre>
    </div>
  </body>
</html>
